<!doctype html>
<html lang="zh-CN" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Posts Manager</title>

    <!-- 1. DaisyUI CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@5"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@5/themes.css"
      rel="stylesheet"
      type="text/css"
    />

    <!-- 2. Tailwind -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- 3. Alpine.js (plugins must be loaded before the core) -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/@alpinejs/mask@3.15.8/dist/cdn.min.js"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.8/dist/cdn.min.js"
    ></script>

    <!-- 4. Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@3.0.0/dist/iconify-icon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.19/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.13.5/dist/axios.min.js"></script>

    <!-- 5. Shared -->
    <script src="./shared.js"></script>
  </head>
  <body class="min-h-screen bg-base-200">
    <div x-data="indexPage">
      <!-- Content -->
      <main class="max-w-4xl mx-auto p-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
          <h1 class="text-2xl font-bold flex items-center gap-2">
            <iconify-icon icon="lucide:file-text"></iconify-icon>
            Posts Manager
          </h1>
          <button class="btn btn-primary" @click="handleOpenCreate">
            <iconify-icon icon="lucide:plus"></iconify-icon>
            New Post
          </button>
        </div>

        <!-- Filter -->
        <div class="flex gap-2 mb-4">
          <select
            class="select select-bordered select-sm"
            x-model="filterUserId"
            @change="fetchPosts"
          >
            <option value="">All Users</option>
            <template x-for="u in users" :key="u.id">
              <option :value="u.id" x-text="u.name"></option>
            </template>
          </select>
        </div>

        <!-- Read: skeleton loading -->
        <template x-if="isLoading">
          <div class="space-y-4">
            <template x-for="n in 5">
              <div class="card bg-base-100 shadow p-6">
                <div class="skeleton h-5 w-2/3 mb-3"></div>
                <div class="skeleton h-4 w-full mb-2"></div>
                <div class="skeleton h-4 w-4/5"></div>
              </div>
            </template>
          </div>
        </template>

        <!-- Read: error with inline alert + retry -->
        <template x-if="!isLoading && hasError">
          <div class="alert alert-error">
            <iconify-icon icon="lucide:alert-circle"></iconify-icon>
            <span x-text="errorMessage"></span>
            <button class="btn btn-sm btn-ghost" @click="fetchPosts">
              <iconify-icon icon="lucide:refresh-cw"></iconify-icon>
              Retry
            </button>
          </div>
        </template>

        <!-- Read: empty state -->
        <template x-if="!isLoading && !hasError && posts.length === 0">
          <div class="text-center py-12 text-base-content/50">
            <iconify-icon
              icon="lucide:inbox"
              class="text-4xl mb-2"
            ></iconify-icon>
            <p>No posts found</p>
          </div>
        </template>

        <!-- Read: post list -->
        <template x-if="!isLoading && !hasError && posts.length > 0">
          <div class="space-y-4">
            <template x-for="post in posts" :key="post.id">
              <div class="card bg-base-100 shadow">
                <div class="card-body">
                  <div class="flex items-start justify-between gap-4">
                    <div class="flex-1 min-w-0">
                      <h2 class="card-title text-base" x-text="post.title"></h2>
                      <p
                        class="text-sm text-base-content/70 mt-1 line-clamp-2"
                        x-text="post.body"
                      ></p>
                      <div
                        class="flex items-center gap-3 mt-2 text-xs text-base-content/50"
                      >
                        <span class="flex items-center gap-1">
                          <iconify-icon icon="lucide:user"></iconify-icon>
                          User <span x-text="post.userId"></span>
                        </span>
                        <span class="flex items-center gap-1">
                          <iconify-icon icon="lucide:hash"></iconify-icon>
                          <span x-text="post.id"></span>
                        </span>
                      </div>
                    </div>
                    <div class="flex gap-1">
                      <button
                        class="btn btn-ghost btn-sm btn-square"
                        @click="handleOpenDetail(post)"
                      >
                        <iconify-icon icon="lucide:eye"></iconify-icon>
                      </button>
                      <button
                        class="btn btn-ghost btn-sm btn-square"
                        @click="handleOpenEdit(post)"
                      >
                        <iconify-icon icon="lucide:pencil"></iconify-icon>
                      </button>
                      <button
                        class="btn btn-ghost btn-sm btn-square text-error"
                        @click="handleOpenDelete(post)"
                      >
                        <iconify-icon icon="lucide:trash-2"></iconify-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </template>
      </main>

      <!-- Modal: Detail (view comments) -->
      <dialog x-ref="detailModal" class="modal">
        <div class="modal-box max-w-2xl">
          <h3 class="font-bold text-lg" x-text="currentPost.title"></h3>
          <p class="py-4 text-base-content/80" x-text="currentPost.body"></p>

          <div class="divider">Comments</div>

          <template x-if="isLoadingComments">
            <div class="space-y-3">
              <template x-for="n in 3">
                <div>
                  <div class="skeleton h-4 w-1/3 mb-2"></div>
                  <div class="skeleton h-3 w-full"></div>
                </div>
              </template>
            </div>
          </template>

          <template x-if="!isLoadingComments && comments.length > 0">
            <div class="space-y-3 max-h-60 overflow-y-auto">
              <template x-for="c in comments" :key="c.id">
                <div class="bg-base-200 rounded-lg p-3">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="font-semibold text-sm" x-text="c.name"></span>
                    <span
                      class="text-xs text-base-content/50"
                      x-text="c.email"
                    ></span>
                  </div>
                  <p class="text-sm text-base-content/70" x-text="c.body"></p>
                </div>
              </template>
            </div>
          </template>

          <div class="modal-action">
            <form method="dialog">
              <button class="btn">Close</button>
            </form>
          </div>
        </div>
      </dialog>

      <!-- Modal: Create / Edit -->
      <dialog x-ref="formModal" class="modal">
        <div class="modal-box">
          <h3
            class="font-bold text-lg"
            x-text="isEditing ? 'Edit Post' : 'New Post'"
          ></h3>
          <div class="space-y-4 py-4">
            <label class="form-control w-full">
              <div class="label"><span class="label-text">Title</span></div>
              <input
                type="text"
                class="input input-bordered w-full"
                x-model="formData.title"
                placeholder="Enter post title"
              />
            </label>
            <label class="form-control w-full">
              <div class="label"><span class="label-text">Body</span></div>
              <textarea
                class="textarea textarea-bordered w-full h-32"
                x-model="formData.body"
                placeholder="Enter post content"
              ></textarea>
            </label>
            <label class="form-control w-full">
              <div class="label"><span class="label-text">User ID</span></div>
              <input
                type="text"
                class="input input-bordered w-full"
                x-model="formData.userId"
                x-mask="99"
                placeholder="1-10"
              />
            </label>
          </div>
          <div class="modal-action">
            <form method="dialog">
              <button class="btn">Cancel</button>
            </form>
            <button
              class="btn btn-primary"
              :class="isSubmitting && 'loading'"
              :disabled="isSubmitting"
              @click="handleSubmitForm"
            >
              <template x-if="!isSubmitting">
                <iconify-icon icon="lucide:check"></iconify-icon>
              </template>
              Save
            </button>
          </div>
        </div>
      </dialog>

      <!-- Modal: Delete confirm -->
      <dialog x-ref="deleteModal" class="modal">
        <div class="modal-box">
          <h3 class="font-bold text-lg flex items-center gap-2 text-error">
            <iconify-icon icon="lucide:alert-triangle"></iconify-icon>
            Delete Post
          </h3>
          <p class="py-4">
            Are you sure you want to delete "<span
              class="font-semibold"
              x-text="currentPost.title"
            ></span
            >"?
          </p>
          <div class="modal-action">
            <form method="dialog">
              <button class="btn">Cancel</button>
            </form>
            <button
              class="btn btn-error"
              :class="isDeleting && 'loading'"
              :disabled="isDeleting"
              @click="handleConfirmDelete"
            >
              Delete
            </button>
          </div>
        </div>
      </dialog>

      <!-- Toast (do not remove) -->
      <div class="toast toast-top toast-center">
        <template x-for="t in $store.toast.items" :key="t.id">
          <div x-transition :class="'alert alert-' + t.type">
            <span x-text="t.message"></span>
          </div>
        </template>
      </div>
    </div>

    <script>
      document.addEventListener("alpine:init", () => {
        Alpine.data("indexPage", () => ({
          // -- State --
          isLoading: false,
          isSubmitting: false,
          isDeleting: false,
          isLoadingComments: false,
          hasError: false,
          errorMessage: "",
          posts: [],
          users: [],
          comments: [],
          filterUserId: "",
          currentPost: {},
          isEditing: false,
          formData: { title: "", body: "", userId: "" },

          // -- Lifecycle --
          async init() {
            await Promise.all([this.fetchPosts(), this.fetchUsers()]);
          },

          // -- Read: fetch posts --
          async fetchPosts() {
            this.isLoading = true;
            this.hasError = false;
            try {
              const params = {};
              if (this.filterUserId) params.userId = this.filterUserId;
              const { data } = await postApi.getList(params);
              this.posts = data;
            } catch (e) {
              this.hasError = true;
              this.errorMessage = e.message || "Failed to load posts";
            } finally {
              this.isLoading = false;
            }
          },

          // -- Read: fetch users for filter --
          async fetchUsers() {
            try {
              const { data } = await userApi.getList();
              this.users = data;
            } catch (e) {
              console.error("Failed to load users:", e);
            }
          },

          // -- Read: fetch comments --
          async fetchComments(postId) {
            this.isLoadingComments = true;
            try {
              const { data } = await commentApi.getByPost(postId);
              this.comments = data;
            } catch (e) {
              this.comments = [];
            } finally {
              this.isLoadingComments = false;
            }
          },

          // -- Modal: detail --
          handleOpenDetail(post) {
            this.currentPost = post;
            this.comments = [];
            this.$refs.detailModal.showModal();
            this.fetchComments(post.id);
          },

          // -- Modal: create --
          handleOpenCreate() {
            this.isEditing = false;
            this.formData = { title: "", body: "", userId: "1" };
            this.$refs.formModal.showModal();
          },

          // -- Modal: edit --
          handleOpenEdit(post) {
            this.isEditing = true;
            this.currentPost = post;
            this.formData = {
              title: post.title,
              body: post.body,
              userId: String(post.userId),
            };
            this.$refs.formModal.showModal();
          },

          // -- Write: create or update --
          async handleSubmitForm() {
            this.isSubmitting = true;
            try {
              const payload = {
                title: this.formData.title,
                body: this.formData.body,
                userId: Number(this.formData.userId),
              };
              if (this.isEditing) {
                await postApi.update(this.currentPost.id, payload);
                const idx = this.posts.findIndex(
                  (p) => p.id === this.currentPost.id,
                );
                if (idx !== -1)
                  this.posts[idx] = { ...this.posts[idx], ...payload };
                toast("Post updated", "success");
              } else {
                const { data } = await postApi.create(payload);
                this.posts.unshift({ ...payload, id: data.id });
                toast("Post created", "success");
              }
              this.$refs.formModal.close();
            } catch (e) {
              toast(e.message || "Save failed", "error");
            } finally {
              this.isSubmitting = false;
            }
          },

          // -- Modal: delete confirm --
          handleOpenDelete(post) {
            this.currentPost = post;
            this.$refs.deleteModal.showModal();
          },

          // -- Write: delete --
          async handleConfirmDelete() {
            this.isDeleting = true;
            try {
              await postApi.remove(this.currentPost.id);
              this.posts = this.posts.filter(
                (p) => p.id !== this.currentPost.id,
              );
              toast("Post deleted", "success");
              this.$refs.deleteModal.close();
            } catch (e) {
              toast(e.message || "Delete failed", "error");
            } finally {
              this.isDeleting = false;
            }
          },
        }));
      });
    </script>
  </body>
</html>
